<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic%7Cserif:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"manual"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="My day-to-day work diary of my college project. Part 1 (Week 0 - Week 2)">
<meta property="og:type" content="article">
<meta property="og:title" content="EE Project Work Diary (pt1)">
<meta property="og:url" content="http://example.com/2023/05/26/009-EE-Project-Work-Diary-pt1/index.html">
<meta property="og:site_name" content="This is Amor">
<meta property="og:description" content="My day-to-day work diary of my college project. Part 1 (Week 0 - Week 2)">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/arena-illustration.png?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/rover-mode.png?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/test-arena-final-photo.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/FPGA-cap-board-pin-mapping.png?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/data_processing_diagram.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/basic_algorithm.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/data_structure.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/state_machine.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/optimisation_methods.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/wall_detection.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/wall_detection_algorithm.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/beacon_detection_algorithm.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/VGA_display.jpg?raw=true">
<meta property="og:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/server_communication.jpg?raw=true">
<meta property="article:published_time" content="2023-05-26T18:14:13.000Z">
<meta property="article:modified_time" content="2023-06-18T12:34:22.096Z">
<meta property="article:author" content="Amor">
<meta property="article:tag" content="college">
<meta property="article:tag" content="project">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/arena-illustration.png?raw=true">


<link rel="canonical" href="http://example.com/2023/05/26/009-EE-Project-Work-Diary-pt1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2023/05/26/009-EE-Project-Work-Diary-pt1/","path":"2023/05/26/009-EE-Project-Work-Diary-pt1/","title":"EE Project Work Diary (pt1)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>EE Project Work Diary (pt1) | This is Amor</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">This is Amor</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section">Home</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section">Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section">Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section">Tags</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section">About</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Week-0"><span class="nav-number">1.</span> <span class="nav-text">Week 0</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#May-18th-Thu"><span class="nav-number">1.1.</span> <span class="nav-text">May 18th (Thu)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Functional-Requirements"><span class="nav-number">1.1.1.</span> <span class="nav-text">Functional Requirements</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Non-Functional-Requirements"><span class="nav-number">1.1.2.</span> <span class="nav-text">Non-Functional Requirements</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Year-1-and-Year-2-Content"><span class="nav-number">1.1.3.</span> <span class="nav-text">Year 1 and Year 2 Content</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Constraints"><span class="nav-number">1.1.4.</span> <span class="nav-text">Constraints</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#May-19th-Fri"><span class="nav-number">1.2.</span> <span class="nav-text">May 19th (Fri)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Tasks"><span class="nav-number">1.2.1.</span> <span class="nav-text">Tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Initial-plan"><span class="nav-number">1.2.2.</span> <span class="nav-text">Initial plan</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#May-20th-Sat"><span class="nav-number">1.3.</span> <span class="nav-text">May 20th (Sat)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Server-checklist"><span class="nav-number">1.3.1.</span> <span class="nav-text">Server checklist</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Week-1"><span class="nav-number">2.</span> <span class="nav-text">Week 1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#May-22nd-Mon"><span class="nav-number">2.1.</span> <span class="nav-text">May 22nd (Mon)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ESP32-WiFi-connection"><span class="nav-number">2.1.1.</span> <span class="nav-text">ESP32 WiFi connection</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#May-23rd-Tue"><span class="nav-number">2.2.</span> <span class="nav-text">May 23rd (Tue)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#May-24th-Wed"><span class="nav-number">2.3.</span> <span class="nav-text">May 24th (Wed)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Maze-complexity"><span class="nav-number">2.3.1.</span> <span class="nav-text">Maze complexity</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#May-25th-Thu"><span class="nav-number">2.4.</span> <span class="nav-text">May 25th (Thu)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ESP32-checklist-updated"><span class="nav-number">2.4.1.</span> <span class="nav-text">ESP32 checklist (updated)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pin-mapping"><span class="nav-number">2.4.2.</span> <span class="nav-text">Pin mapping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Maze-solving-algorithm"><span class="nav-number">2.4.3.</span> <span class="nav-text">Maze solving algorithm</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#May-26th-Fri"><span class="nav-number">2.5.</span> <span class="nav-text">May 26th (Fri)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Stepper-motor-control"><span class="nav-number">2.5.1.</span> <span class="nav-text">Stepper motor control</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Database-attribute-structure"><span class="nav-number">2.5.2.</span> <span class="nav-text">Database attribute structure</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Week-2"><span class="nav-number">3.</span> <span class="nav-text">Week 2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#May-29th-Mon"><span class="nav-number">3.1.</span> <span class="nav-text">May 29th (Mon)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Angle-calculation"><span class="nav-number">3.1.1.</span> <span class="nav-text">Angle calculation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#State-machine"><span class="nav-number">3.1.2.</span> <span class="nav-text">State machine</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#May-30th-Tue"><span class="nav-number">3.2.</span> <span class="nav-text">May 30th (Tue)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-structure-Node"><span class="nav-number">3.2.1.</span> <span class="nav-text">Data structure - Node</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-structure-process-stack"><span class="nav-number">3.2.2.</span> <span class="nav-text">Data structure - process stack</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#May-31st-Wed"><span class="nav-number">3.3.</span> <span class="nav-text">May 31st (Wed)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Interim-Presentation"><span class="nav-number">3.3.1.</span> <span class="nav-text">Interim Presentation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FPGA-algorithm"><span class="nav-number">3.3.2.</span> <span class="nav-text">FPGA algorithm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Server-communication"><span class="nav-number">3.3.3.</span> <span class="nav-text">Server communication</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jun-1st-Thur"><span class="nav-number">3.4.</span> <span class="nav-text">Jun 1st (Thur)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Optimisation"><span class="nav-number">3.4.1.</span> <span class="nav-text">Optimisation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UART-communication"><span class="nav-number">3.4.2.</span> <span class="nav-text">UART communication</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jun-2nd-Fri"><span class="nav-number">3.5.</span> <span class="nav-text">Jun 2nd (Fri)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Stepper-motor-control-1"><span class="nav-number">3.5.1.</span> <span class="nav-text">Stepper motor control</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MCU6050-data-processing"><span class="nav-number">3.5.2.</span> <span class="nav-text">MCU6050 data processing</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Chasis-and-balance"><span class="nav-number">3.5.3.</span> <span class="nav-text">Chasis and balance</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Amor"
      src="/images/amor_avatar.gif">
  <p class="site-author-name" itemprop="name">Amor</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/thisisamor" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;thisisamor" rel="noopener me" target="_blank">GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://amor-zhao.notion.site/amor-zhao/Amor-s-Dashboard-33d838340d45480980835d213c19ea5a" title="Dashboard → https:&#x2F;&#x2F;amor-zhao.notion.site&#x2F;amor-zhao&#x2F;Amor-s-Dashboard-33d838340d45480980835d213c19ea5a" rel="noopener me" target="_blank">Dashboard</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/26/009-EE-Project-Work-Diary-pt1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/amor_avatar.gif">
      <meta itemprop="name" content="Amor">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="This is Amor">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="EE Project Work Diary (pt1) | This is Amor">
      <meta itemprop="description" content="My day-to-day work diary of my college project. Part 1 (Week 0 - Week 2)">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          EE Project Work Diary (pt1)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 26-05-2023 19:14:13" itemprop="dateCreated datePublished" datetime="2023-05-26T19:14:13+01:00">26-05-2023</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Project/" itemprop="url" rel="index"><span itemprop="name">Project</span></a>
        </span>
    </span>

  
</div>


          
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p style="opacity: 0.7;">Start Notes: 

<p><small style="opacity: 0.7;"> Our second end-of-year project is to build a dynamically balanced rover which is capable of exploring and solving an irregular maze through camera detection and analysis, and present the result on a website with the help of reliable server communication and database. </small></p>
<hr>
<h2 id="Week-0"><a href="#Week-0" class="headerlink" title="Week 0"></a>Week 0</h2><h3 id="May-18th-Thu"><a href="#May-18th-Thu" class="headerlink" title="May 18th (Thu)"></a>May 18th (Thu)</h3><p><mark style="background-color: #7099a7;"> Year 2 project introduction. </mark></p>
<h4 id="Functional-Requirements"><a href="#Functional-Requirements" class="headerlink" title="Functional Requirements"></a>Functional Requirements</h4><p>Autonomously move through a maze without crossing an illuminated line</p>
<ol>
<li>Autonomously survey the layout of the maze and produce a map of the<br>discovered layout, overlaid with the position of the robot and the shortest<br>path through the maze</li>
<li>Balance on two wheels</li>
</ol>
<h4 id="Non-Functional-Requirements"><a href="#Non-Functional-Requirements" class="headerlink" title="Non-Functional Requirements"></a>Non-Functional Requirements</h4><ol>
<li>Reliable and able to complete its task without human intervention</li>
<li>Robust and efficient construction</li>
<li>Coded for: a. Usability b. Testability c. Maintainability d. Scalability</li>
</ol>
<h4 id="Year-1-and-Year-2-Content"><a href="#Year-1-and-Year-2-Content" class="headerlink" title="Year 1 and Year 2 Content"></a>Year 1 and Year 2 Content</h4><p>Prototyping (labs)</p>
<p>Test and diagnosis (labs)</p>
<p>Software Skills (C++, AWS, node.js, React, MySQL)</p>
<p>Embedded Programming</p>
<p>Control Systems</p>
<p>Digital systems (FPGA, Verilog, NIOS II)</p>
<p>Power systems</p>
<h4 id="Constraints"><a href="#Constraints" class="headerlink" title="Constraints"></a>Constraints</h4><p>The project has constraints to maintain the level of challenge:</p>
<ol>
<li>The permitted means of locating the robot within the maze are:</li>
</ol>
<ul>
<li>Dead-reckoning based on accelerometer, gyroscope and wheel revolution<br>counting</li>
<li>Optical detection of the maze markings and up to three illuminated beacons by<br>the robot</li>
</ul>
<ol start="2">
<li>Illuminated beacons shall be powered by a specified PV-array emulator and provided<br>energy conversion modules</li>
<li>The robot will use the provided FPGA-based camera system</li>
</ol>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/arena-illustration.png?raw=true" alt="Arena illustration"></p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/rover-mode.png?raw=true" alt="rover mode"></p>
<hr>
<h3 id="May-19th-Fri"><a href="#May-19th-Fri" class="headerlink" title="May 19th (Fri)"></a>May 19th (Fri)</h3><p><mark style="background-color: #7099a7;"> First group meeting, discussed about the project requirements, went up with the basic idea of rover algorithm, listed and assigned tasks. </mark></p>
<h4 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h4><ol>
<li>balance (mechanical, dynamic) motor controller (Tracey &amp; Nicolas)</li>
<li>solar powering - EEE (Tracey &amp; Nicolas)</li>
<li>fpga (camera control) - EIE  (Daisy)</li>
<li>ESP32 microcontroller - (Amor)<ul>
<li>Best route finding algorithm</li>
</ul>
</li>
<li>AWS server - EIE (Jessica)<ul>
<li>( database? )</li>
</ul>
</li>
<li>website ( refresh? ) front end - EIE (Annie)</li>
<li>Data processing (visual detection) - EIE (needed for every task)</li>
</ol>
<h4 id="Initial-plan"><a href="#Initial-plan" class="headerlink" title="Initial plan"></a>Initial plan</h4><p>A very basic algorithm includes: </p>
<ol>
<li>Store data in matrix ( blocks &#x2F; walls detected )</li>
<li>detecting the three adjacent blocks<ol>
<li>any walls?</li>
<li>new blocks? </li>
<li>IF only one possible path remains: exploring algorithm can be optimised</li>
</ol>
</li>
</ol>
<p>For the above algorithm, the following assumptions were made:</p>
<ol>
<li><strong>the rover is capable of calculating the distance it have moved (Distance moved can be calculated using the number of rotations of the stepper motors) in terms of blocks</strong></li>
<li>the rover can only detect the nearest block <ol>
<li>need to find out whether there is better algorithm IF the camera has a wider view - test camera first</li>
</ol>
</li>
<li>the beacons are only used to mark the corners</li>
</ol>
<hr>
<h3 id="May-20th-Sat"><a href="#May-20th-Sat" class="headerlink" title="May 20th (Sat)"></a>May 20th (Sat)</h3><p><mark style="background-color: #7099a7;"> Went though basic JavaScript tutorial, set up AWS server environment for node.js, express and dynamoDB. Designed basic polling algorithm. </mark></p>
<h4 id="Server-checklist"><a href="#Server-checklist" class="headerlink" title="Server checklist"></a>Server checklist</h4><ul>
<li><input checked="" disabled="" type="checkbox"> set up EC2 instance (IP Lab 5 &amp; 6)</li>
<li><input checked="" disabled="" type="checkbox"> install node.js on the EC2 instance  (<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/setting-up-node-on-ec2-instance.html">Tutorial</a>)</li>
<li><input checked="" disabled="" type="checkbox"> Run HTTP server on AWS using node.js<ul>
<li><input checked="" disabled="" type="checkbox"> <code>$npm install express</code></li>
<li><input checked="" disabled="" type="checkbox"> <code>$npm install body-parser</code></li>
<li><input checked="" disabled="" type="checkbox"> <code>$npm install node-html-parser</code></li>
<li><input checked="" disabled="" type="checkbox"> types of HTML response ( table &#x2F; hyperlink &#x2F; tags )</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> (Use Express framework) (a web application framework for Node.js which makes the web application code much easier to maintain and extend)<ul>
<li><input checked="" disabled="" type="checkbox"> Data processing on server side<ul>
<li><input checked="" disabled="" type="checkbox"> parsing</li>
<li><input checked="" disabled="" type="checkbox"> reconstructing</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> (Use react-polling)<ul>
<li><input checked="" disabled="" type="checkbox"> <code>npm i react-polling save</code></li>
</ul>
</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> Use DynamoDB (FOR WHAT)</li>
<li><input disabled="" type="checkbox"> Best route-finding algorithm (after the map is completed)</li>
</ul>
<hr>
<h2 id="Week-1"><a href="#Week-1" class="headerlink" title="Week 1"></a>Week 1</h2><h3 id="May-22nd-Mon"><a href="#May-22nd-Mon" class="headerlink" title="May 22nd (Mon)"></a>May 22nd (Mon)</h3><p><mark style="background-color: #7099a7;"> Wrote code for ESP32 microcontroller to connect to WiFi. Tested with mobile phone hot spot. Set up VS code environment for arduino platform (bcs it looks better). </mark></p>
<p><mark style="background-color: #7099a7;"> Established and tested D8M camera with FPGA connection. (Can see the image from laptop now.) </mark></p>
<h4 id="ESP32-WiFi-connection"><a href="#ESP32-WiFi-connection" class="headerlink" title="ESP32 WiFi connection"></a>ESP32 WiFi connection</h4><p>main set up: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;Arduino.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &quot;wifi_connection.h&quot;</span><br><span class="line"></span><br><span class="line">void setup() &#123;</span><br><span class="line">  Serial.begin(9600);</span><br><span class="line">  wifi_connection(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wifi connection function: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;Arduino.h&gt;</span><br><span class="line">#include &lt;ArduinoJson.h&gt;</span><br><span class="line">#include &lt;WiFi.h&gt;</span><br><span class="line">#include &lt;HTTPClient.h&gt;</span><br><span class="line"></span><br><span class="line">const char* ssid = &quot;ssid&quot;;</span><br><span class="line">const char* password = &quot;password&quot;;</span><br><span class="line"></span><br><span class="line">// ----- connect to wifi -----</span><br><span class="line">void wifi_connection()</span><br><span class="line">&#123;</span><br><span class="line">  Serial.println(&quot;hello&quot;); </span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  Serial.println(&quot;start to connect&quot;);</span><br><span class="line">  while (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    delay(1000);</span><br><span class="line">    Serial.println(&quot;Connecting to WiFi...&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(&quot;Connected to WiFi&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="May-23rd-Tue"><a href="#May-23rd-Tue" class="headerlink" title="May 23rd (Tue)"></a>May 23rd (Tue)</h3><p><mark style="background-color: #7099a7;"> Wrote and tested HTTP POST request with a simple AWS web server. </mark></p>
<p>POST request sent by the rover: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">// ------- POST request ------------------</span><br><span class="line">void client_post()</span><br><span class="line">&#123;</span><br><span class="line">  // Serial.print(&quot;[HTTP] begin...\n&quot;);</span><br><span class="line">  // HTTPClient http; </span><br><span class="line">  // configure traged server and url</span><br><span class="line">  // http.begin(&quot;http://35.176.36.0:8080/&quot;); //HTTP</span><br><span class="line">  // Serial.print(&quot;[HTTP] POST...\n&quot;);</span><br><span class="line">  // int httpCode = http.POST(&quot;something&quot;);</span><br><span class="line"></span><br><span class="line">  // Create JSON payload</span><br><span class="line">  DynamicJsonDocument jsonPayload(128); // the capacity of the JSON document</span><br><span class="line">  </span><br><span class="line">  // TODO: change jsonPayload keys to the ones we want to use in database</span><br><span class="line"></span><br><span class="line">  String i, j, UP, DOWN, LEFT, RIGHT; // input parameters</span><br><span class="line">  // change these with processed data from camera</span><br><span class="line">  jsonPayload[&quot;i&quot;] = &quot;0&quot;; </span><br><span class="line">  jsonPayload[&quot;j&quot;] = &quot;2&quot;; </span><br><span class="line">  // jsonPayload[&#x27;UP&#x27;] = UP; </span><br><span class="line">  // jsonPayload[&#x27;DOWN&#x27;] = DOWN; </span><br><span class="line">  // jsonPayload[&#x27;LEFT&#x27;] = LEFT; </span><br><span class="line">  // jsonPayload[&#x27;RIGHT&#x27;] = RIGHT; </span><br><span class="line"></span><br><span class="line">  // Serialize the JSON document to a string</span><br><span class="line">  String payload;</span><br><span class="line">  serializeJson(jsonPayload, payload);</span><br><span class="line"></span><br><span class="line">  // Send POST request with JSON payload</span><br><span class="line">  HTTPClient http;</span><br><span class="line">  http.begin(&quot;http://35.176.36.0:8080/&quot;);</span><br><span class="line">  http.addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span><br><span class="line">  int httpCode = http.POST(payload);</span><br><span class="line"></span><br><span class="line">  if(httpCode &gt; 0) </span><br><span class="line">  &#123;</span><br><span class="line">    Serial.printf(&quot;[HTTP] GET... code: %d\n&quot;, httpCode);</span><br><span class="line">    if(httpCode == HTTP_CODE_OK) </span><br><span class="line">    &#123;</span><br><span class="line">      String payload = http.getString();</span><br><span class="line">      Serial.println(payload);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  else </span><br><span class="line">  &#123;</span><br><span class="line">    Serial.printf(&quot;[HTTP] GET... failed, error: %s\n&quot;, http.errorToString(httpCode).c_str());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  http.end();</span><br><span class="line">  // delay(5000);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// -------- GET request --------- (for testing only)</span><br><span class="line">void client_get() </span><br><span class="line">&#123;</span><br><span class="line">  if (WiFi.status() == WL_CONNECTED) &#123;</span><br><span class="line">    HTTPClient http;</span><br><span class="line">    // Specify the target URL</span><br><span class="line">    http.begin(&quot;http://35.176.36.0:8080/&quot;);</span><br><span class="line">    // Send the HTTP GET request</span><br><span class="line">    int httpResponseCode = http.GET();</span><br><span class="line">    if (httpResponseCode == HTTP_CODE_OK) </span><br><span class="line">    &#123;</span><br><span class="line">      // Successful response</span><br><span class="line">      String payload = http.getString();</span><br><span class="line">      Serial.println(payload);</span><br><span class="line">    &#125; </span><br><span class="line">    else </span><br><span class="line">    &#123;</span><br><span class="line">      // Error in HTTP request</span><br><span class="line">      Serial.print(&quot;Error code: &quot;);</span><br><span class="line">      Serial.println(httpResponseCode);</span><br><span class="line">    &#125;</span><br><span class="line">    // Close the connection</span><br><span class="line">    http.end();</span><br><span class="line">  &#125;</span><br><span class="line">  // Wait for 5 seconds before making the next request</span><br><span class="line">  delay(5000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Code for testing the connection between ESP board and server: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// when ESP is connected to wifi</span><br><span class="line">// it should be able to send a POST request to the server</span><br><span class="line">// and receive 200 OK as the http code</span><br><span class="line"></span><br><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var server = express();</span><br><span class="line">const port = 8080; </span><br><span class="line"></span><br><span class="line">// web content</span><br><span class="line">let htmlContent = `</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"> &lt;body&gt;</span><br><span class="line"> &lt;h2&gt;This is a test message&lt;/h2&gt;</span><br><span class="line"> &lt;!-- this is a comment: br tag is for line break--&gt;</span><br><span class="line"> &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">server.use(express.json());</span><br><span class="line"></span><br><span class="line">server.get(&#x27;/&#x27;, function(req, res) &#123;</span><br><span class="line">    res.writeHead(200, &#123;&#x27;Content-Type&#x27;:&#x27;text/html&#x27;&#125;);</span><br><span class="line">    res.end(htmlContent);</span><br><span class="line">&#125;);  </span><br><span class="line"></span><br><span class="line">server.post(&#x27;/&#x27;, (req, res) =&gt; &#123;</span><br><span class="line">  const postData = req.body;</span><br><span class="line">  // data processing example</span><br><span class="line">  const responseContent = &quot;&lt;p&gt;Received data: &quot; + postData.i + postData.j + &quot;&lt;/p&gt;&quot;;</span><br><span class="line">  // Send a response back to the client</span><br><span class="line">  res.send(responseContent);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(port, () =&gt; &#123;</span><br><span class="line">  console.log(`Server listening on port $&#123;port&#125;`);</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<hr>
<h3 id="May-24th-Wed"><a href="#May-24th-Wed" class="headerlink" title="May 24th (Wed)"></a>May 24th (Wed)</h3><p><mark style="background-color: #7099a7;"> Met Ed Stott, who instructed more on maze complexity. </mark></p>
<p><mark style="background-color: #7099a7;"> Tested camera detection: when approaching to a wall, set the wall flag to HIGH. (Visual detection was done by setting restrictions on the region of pixels whose colour code is considered as white.) </mark></p>
<p><mark style="background-color: #7099a7;"> Established connection between FPGA output and ESP32 input, encountered problem when using digitalRead on the arduino side. (The voltage output was as expected according to the value measured with a multimeter, but ESP32 constantly read a HIGH input). </mark></p>
<h4 id="Maze-complexity"><a href="#Maze-complexity" class="headerlink" title="Maze complexity"></a>Maze complexity</h4><blockquote>
<p>The robot can locate itself by measuring the angle between the observed positions of the three beacons, when the positions of the beacons are known in advance. The camera is probably the simplest way of observing the beacons.<br>The maze will always start in one corner and finish in the opposite corner. It’s approximately 2.4m x 3.6m. The perimeter of the maze has a light strip.<br>The walls will be (nominally) straight. They won’t be absolutely straight because the corners have a minimum bend radius, but you can map them as straight lines.<br>Some walls will not be parallel with any side of the arena. The smallest gap will be 350mm.<br>There could be multiple paths to solve the maze, aka “floating islands” inside. </p>
</blockquote>
<p><small style="opacity: 0.7;"> I’m not satisfied with this maze complexity specification thing at all. Our department literally had three weeks during our final exams to come up with ideas of our summer project. But in the end, they gave us this briefing with very few components ready and they had no idea what the maze should be like. They initially wanted to build a test arena with blocks and lighting strips where the walls are all parallel to the sides. It was a few days later when they realised that students were planning to map the whole arena as a matrix and decided this would be too straight-forward. They changed the whole arena to make it irregular - and impossible if not discretely calculate the location of the rover. </p>
<p>I’m very glad to have some challenging tasks, but it made me a bit frustrated that they didn’t prepare everything properly and i had to re-plan our algorithm for so many times. </small></p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/test-arena-final-photo.jpg?raw=true" alt="test arena photos"></p>
<hr>
<h3 id="May-25th-Thu"><a href="#May-25th-Thu" class="headerlink" title="May 25th (Thu)"></a>May 25th (Thu)</h3><p><mark style="background-color: #7099a7;"> Solved yesterday’s problem (by applying FPGA cap board pin mapping), tested ESP32 digital read pin from FPGA (a flag showing whether or not a wall is detected). Tested digital write to control FPGA key (zoom in &#x2F; zoom out &#x2F; focus). </mark></p>
<p><mark style="background-color: #7099a7;"> Changed the basic wall detection into more specific requirements: detecting whether or not the wall is horizontal in the camera view. </mark></p>
<p><mark style="background-color: #7099a7;"> Planned new maze solving algorithm on updated maze complexity rules and current ability of camera detection (based on experiment). </mark></p>
<h4 id="ESP32-checklist-updated"><a href="#ESP32-checklist-updated" class="headerlink" title="ESP32 checklist (updated)"></a>ESP32 checklist (updated)</h4><ul>
<li><input checked="" disabled="" type="checkbox"> Downloaded Adafruit MPU6050 Arduino Library </li>
<li><input checked="" disabled="" type="checkbox"> Installed the PlatformIO VS Code Extension </li>
<li><input disabled="" type="checkbox"> maze algorithm<ul>
<li><input disabled="" type="checkbox"> data structure</li>
<li><input disabled="" type="checkbox"> optimisation?<ul>
<li><input disabled="" type="checkbox"> UART communication → calculate wall angle faster?</li>
<li><input disabled="" type="checkbox"> calculate distance faster?</li>
<li><input disabled="" type="checkbox"> more efficient data structure</li>
</ul>
</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> camera detection</li>
<li><input disabled="" type="checkbox"> motor command</li>
<li><input disabled="" type="checkbox"> location calculation</li>
<li><input checked="" disabled="" type="checkbox"> wifi + http POST request</li>
</ul>
<h4 id="Pin-mapping"><a href="#Pin-mapping" class="headerlink" title="Pin mapping"></a>Pin mapping</h4><table>
<thead>
<tr>
<th>FPGA pin</th>
<th>cap board pin</th>
<th>ESP 32 pin</th>
<th>Usage</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>KEY0</td>
<td>8</td>
<td>IO17</td>
<td>camera auto focus</td>
<td>HIGH&#x3D;push button;</td>
</tr>
<tr>
<td>KEY1</td>
<td>9</td>
<td>IO16</td>
<td>camera bin level (zoom)</td>
<td>HIGH&#x3D;push button;</td>
</tr>
<tr>
<td>IO[11:10]</td>
<td>[11:10]</td>
<td>IO4 + IO14</td>
<td>wall detection</td>
<td>00 &#x3D; no_wall; 10 &#x3D; <code>\</code>; 01 &#x3D; <code>/</code>; 11 &#x3D; both;</td>
</tr>
<tr>
<td>IO[12]</td>
<td>12</td>
<td>IO15</td>
<td>horizontal flag</td>
<td>1 &#x3D; horizontal;</td>
</tr>
<tr>
<td>IO[7:6]</td>
<td>[7:6]</td>
<td>IO5 + IO18</td>
<td>beacon detection</td>
<td></td>
</tr>
</tbody></table>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/FPGA-cap-board-pin-mapping.png?raw=true" alt="pin mapping"></p>
<h4 id="Maze-solving-algorithm"><a href="#Maze-solving-algorithm" class="headerlink" title="Maze solving algorithm"></a>Maze solving algorithm</h4><ol>
<li><p>Depth-first searching</p>
<ul>
<li>move as far as possible; </li>
<li>if “dead-end’, return to the last node; </li>
<li>stop as few times as possible; </li>
<li>benefit from the “already explored” regions;</li>
</ul>
</li>
<li><p>Camera detection</p>
<ul>
<li><p>FPGA keeps sending a 2-bit signal <code>wall_detection</code> to ESP32</p>
<ul>
<li><p>00 &#x3D; <code>no_wall</code><br>  If there is no wall in front of the rover, continue forward; </p>
</li>
<li><p>10 &#x3D; <code>left_wall</code><br>  There is wall in front of the rover, the rover must stop immediately.<br>  The wall is in <code>/</code> direction. </p>
</li>
<li><p>01 &#x3D; <code>right_wall</code><br>  There is wall in front of the rover, the rover must stop immediately.<br>  The wall is in <code>\</code> direction. </p>
</li>
<li><p>11 &#x3D; <code>horizontal_wall</code><br>  When the rover finds itself approaching to a wall with some degree (rather than perpendicularly), it would then turn around, until the camera detects that the wall in front of it becomes “horizontal” in the lower part of the view. </p>
<p>  If the rover is approaching a wall perpendicularly, this signal should change from 00 directly to 11.</p>
</li>
</ul>
</li>
<li><p>FPGA keeps sending a 2-bit signal <code>beacon_detection</code> to ESP32</p>
<ul>
<li>need to do experiments with the beacon lighted up</li>
<li>Current idea is to use 01, 10, 11 to refer to the three colours. The microcontroller would calculate the angles between each beacon from the revolution of the stepper motors. With the information of the length and width of the whole maze, the microcontroller is then capable to calculate the following values: (using trigonalmetric)<ul>
<li>its current postion (i, j index)</li>
<li>adjust the horizontal and vertical routes</li>
</ul>
</li>
</ul>
<p>  (We have to use this method to locate the rover, because the slight uncertainty in distance and angle mesaurement might be carried forward, and could end up with large errors in the final plot.)</p>
</li>
</ul>
</li>
<li><p>During any movement, the microcontroller would keep track of the “positions it have been to”, and store the trace in a map. At the points where it have turned around and successfully found new path, a node would be made.<br> There are two possible ways to represent the maze data (when sending request to the server): </p>
<ul>
<li><p>Method 1:<br>  The microcontroller sends the nodes’ information to the server, this is a graph data structure (like we used in discrete maths course). (It cannot be a matrix as the walls are not plotted on a grid.)<br>  The website would have to use the trace to recontruct the maze.<br>  The walls’ angles are measured (as described in “wall detection”), these should also be stored as attributes of the nodes. </p>
</li>
<li><p>Method 2:<br>  Instead of sending the trace to the server, the microcontroller tries to calculate the intersection points of the walls. This time the nodes in the database would be representing the corners in the maze (or when the wall just goes like: <code>|</code> )<br>  Both methods have the same maze exploring algorithm, the latter one would require the microcontroller to do a bit more calculation. Either way is possible, the server could insert a new line into its database for the website to use.</p>
</li>
</ul>
</li>
<li><p>Trial and error</p>
<ul>
<li>the closest point (before the rover have to stop in front of a wall)  ↔ threshold for FPGA to check the y value of wall detection</li>
<li>measure that distance ↔ for calculation of wall intersection coordinate</li>
<li>angle of camera installation ↔ able to detect beacons and walls at the same time<br>  (the zoom in function on FPGA could be controlled by ESP32, so it is possible to change the view during maze exploration.)</li>
</ul>
</li>
</ol>
<hr>
<h3 id="May-26th-Fri"><a href="#May-26th-Fri" class="headerlink" title="May 26th (Fri)"></a>May 26th (Fri)</h3><p><mark style="background-color: #7099a7;"> Tested 3-bit wall detection, wrote and tested digital read function with threshold values for unstable camera detection scenarios. Lit up the beacons and tested colour detection. </mark></p>
<p><mark style="background-color: #7099a7;"> Discussed and planned the data structure for communication between ESP32 and web server. Tested the plotting code which uses the trace of rover to reconstruct the maze (JS + CSS). </mark></p>
<p><mark style="background-color: #7099a7;"> Designed the state machine for motor control algorithm and added conditions on wall detection. </mark></p>
<h4 id="Stepper-motor-control"><a href="#Stepper-motor-control" class="headerlink" title="Stepper motor control"></a>Stepper motor control</h4><p>NEMA-17 is unipolar, hybrid stepping motor with a 1.8° step angle (200 steps&#x2F;revolution). Each phase draws 1.2 A at 4 V. </p>
<p>Stepper motors move in discrete steps, and the stepper motor driver generates the appropriate control signals to drive the motor in the desired direction and step size. It receives step commands from the microcontroller and translates them into the required sequence of electrical pulses to move the motor shaft.</p>
<p>Some stepper motor drivers also support microstepping, which allows for smoother and more precise movements by dividing each step into smaller microsteps.</p>
<p>We need the motor driver to be precise, in order to precisely:</p>
<ol>
<li>turn the rover around untill the beacon is detected &amp; located in the center of the camera view</li>
<li>control &amp; count the number of steps &amp; revolutions (calculate the distance &amp; angle based on the revolution counts)</li>
<li>Powering?</li>
</ol>
<h4 id="Database-attribute-structure"><a href="#Database-attribute-structure" class="headerlink" title="Database attribute structure"></a>Database attribute structure</h4><table>
<thead>
<tr>
<th>node_id</th>
<th>x</th>
<th>y</th>
<th>connect</th>
</tr>
</thead>
</table>
<table>
<thead>
<tr>
<th>node_id</th>
<th>connect_id</th>
</tr>
</thead>
</table>
<p>(Many-to-many relationships got created new relations in relational schema.)</p>
<hr>
<p>This weekend: </p>
<ul>
<li><input checked="" disabled="" type="checkbox"> Design the state machine so that it fits into the loop function in arduino. </li>
<li><input disabled="" type="checkbox"> Go through the graph searching algorithm, see if there is anything to improve. <ul>
<li><input checked="" disabled="" type="checkbox"> memory data structure </li>
<li><input disabled="" type="checkbox"> least amount of turning around</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> If red and yellow beacons are hard to recognise, position calculation optimisation.</li>
</ul>
<hr>
<h2 id="Week-2"><a href="#Week-2" class="headerlink" title="Week 2"></a>Week 2</h2><h3 id="May-29th-Mon"><a href="#May-29th-Mon" class="headerlink" title="May 29th (Mon)"></a>May 29th (Mon)</h3><p><mark style="background-color: #7099a7;"> Modified function to read beacon detection result from FPGA (mostly the same as wall detection), wrote the corresponging functions for position calculation and estimation (the first one uses angle measured between 2 beacons to locate itself inside the maze, the second one estimates its position simply by adding the revolution of motor to the previous position). </mark></p>
<p><mark style="background-color: #7099a7;"> Designed and implemented a state machine in ESP32 data memory to keep track of the state. The state would be checked at the beginning of each loop, after which the program would enter the corresponding condition to execute the functions. </mark></p>
<h4 id="Angle-calculation"><a href="#Angle-calculation" class="headerlink" title="Angle calculation"></a>Angle calculation</h4><h4 id="State-machine"><a href="#State-machine" class="headerlink" title="State machine"></a>State machine</h4><p>The following code shows how the state machine is implemented inside data memo. More sates may have to be added later (eg: <code>try</code> state is when a wall is supposed to be “horizontal” but the rover is approaching from a certain angle because of motor uncertainty, and would not trigger the flag). </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">typedef enum </span><br><span class="line">&#123;</span><br><span class="line">    no_wall,</span><br><span class="line">    turn_left,</span><br><span class="line">    turn_right,</span><br><span class="line">    // may have: try</span><br><span class="line">    new_node,</span><br><span class="line">    find_next_path, </span><br><span class="line">    // optional: fast</span><br><span class="line">    finish</span><br><span class="line">&#125; State;</span><br><span class="line">State currentState = no_wall;</span><br><span class="line">void next_state(int next)</span><br><span class="line">&#123;</span><br><span class="line">    switch (currentState) </span><br><span class="line">    &#123;</span><br><span class="line">        case no_wall:  // 0</span><br><span class="line">            if (next == 010) </span><br><span class="line">            &#123;</span><br><span class="line">                currentState = turn_left;</span><br><span class="line">            &#125; </span><br><span class="line">            else if(next == 100)</span><br><span class="line">            &#123;</span><br><span class="line">                currentState = turn_right; </span><br><span class="line">            &#125;</span><br><span class="line">            else if(next == 111)</span><br><span class="line">            &#123;</span><br><span class="line">                currentState = new_node; </span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case turn_left:  // 1</span><br><span class="line">            currentState = new_node;</span><br><span class="line">            break;</span><br><span class="line">        case turn_right:  // 2</span><br><span class="line">            currentState = new_node;</span><br><span class="line">            break;</span><br><span class="line">        case new_node:  // 3</span><br><span class="line">            currentState = find_next_path;</span><br><span class="line">            break;</span><br><span class="line">        case find_next_path:  // 4</span><br><span class="line">            currentState = no_wall;</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            currentState = no_wall;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="May-30th-Tue"><a href="#May-30th-Tue" class="headerlink" title="May 30th (Tue)"></a>May 30th (Tue)</h3><p><mark style="background-color: #7099a7;"> Wrote code for Node data structure and process stack. This should enable the rover to store the explored part of the maze for optimisation. More algorithm have to be implemented though. </mark></p>
<h4 id="Data-structure-Node"><a href="#Data-structure-Node" class="headerlink" title="Data structure - Node"></a>Data structure - Node</h4><p>The following is the hash table that nodes are going to be stored in. I’m not that confirmed that we are using hash table? may have to think about the best way to store &amp; look things up later… TODO TODO TODO…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">struct Node</span><br><span class="line">&#123;</span><br><span class="line">    int node_id; </span><br><span class="line">    std::pair&lt;int, int&gt; position; </span><br><span class="line">    std::vector&lt;std::vector&lt;int&gt;&gt; connected_node; </span><br><span class="line">    // [0] = id; [1] = left_wall; [2] = right_wall; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">struct HashEntry </span><br><span class="line">&#123;</span><br><span class="line">    int key;</span><br><span class="line">    Node value;</span><br><span class="line">    struct HashEntry* next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#define TABLE_SIZE 30</span><br><span class="line">struct HashTable </span><br><span class="line">&#123;</span><br><span class="line">    struct HashEntry* table[TABLE_SIZE];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int hashFunction(int key) </span><br><span class="line">&#123;</span><br><span class="line">    // Perform some hash calculation based on the key</span><br><span class="line">    return key % TABLE_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HashTable* node_graph = NULL; </span><br><span class="line">Node null_node; </span><br><span class="line">int last_id; </span><br><span class="line"></span><br><span class="line">void insert(struct HashTable* ht, int key, Node value) </span><br><span class="line">&#123;</span><br><span class="line">    int index = hashFunction(key);</span><br><span class="line">    </span><br><span class="line">    // Create a new entry</span><br><span class="line">    struct HashEntry* newEntry = (struct HashEntry*)malloc(sizeof(struct HashEntry));</span><br><span class="line">    newEntry-&gt;key = key;</span><br><span class="line">    newEntry-&gt;value = value;</span><br><span class="line">    newEntry-&gt;next = NULL;</span><br><span class="line">    </span><br><span class="line">    // Check if the index is empty</span><br><span class="line">    if (ht-&gt;table[index] == NULL) </span><br><span class="line">    &#123;</span><br><span class="line">        ht-&gt;table[index] = newEntry;</span><br><span class="line">    &#125; </span><br><span class="line">    else </span><br><span class="line">    &#123;</span><br><span class="line">        // Handle collision by chaining</span><br><span class="line">        struct HashEntry* current = ht-&gt;table[index];</span><br><span class="line">        while (current-&gt;next != NULL) &#123;</span><br><span class="line">            current = current-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        current-&gt;next = newEntry;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void graph_init()</span><br><span class="line">&#123;</span><br><span class="line">    Node node0; </span><br><span class="line">    node0.node_id = 0; </span><br><span class="line">    node0.position = std::make_pair(175, -175); </span><br><span class="line">    insert(node_graph, 0, node0); </span><br><span class="line">    last_id = 0; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Node get_node(struct HashTable* ht, int key)</span><br><span class="line">&#123;</span><br><span class="line">    int index = hashFunction(key);</span><br><span class="line">    </span><br><span class="line">    // Traverse the linked list at the index</span><br><span class="line">    struct HashEntry* current = ht-&gt;table[index];</span><br><span class="line">    while (current != NULL) </span><br><span class="line">    &#123;</span><br><span class="line">        if (current-&gt;key == key) </span><br><span class="line">        &#123;</span><br><span class="line">            return current-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    // should not happen</span><br><span class="line">    Serial.println(&quot;Wrong: cannot find node!&quot;); </span><br><span class="line">    return null_node; // (if not found)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void add_node( std::pair&lt;int, int&gt; new_node_position, std::vector&lt;std::vector&lt;int&gt;&gt; connect )</span><br><span class="line">&#123;</span><br><span class="line">    Node tmp; </span><br><span class="line">    last_id ++; </span><br><span class="line">    tmp.node_id = last_id; </span><br><span class="line">    tmp.position = new_node_position; </span><br><span class="line">    tmp.connected_node = connect; </span><br><span class="line">    insert(node_graph, last_id, tmp); </span><br><span class="line">    Serial.println(&quot;New node added!&quot;); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void update_node( struct HashTable* ht, int key, std::vector&lt;std::vector&lt;int&gt;&gt; new_connect )</span><br><span class="line">&#123;</span><br><span class="line">    int hashValue = hashFunction(key); </span><br><span class="line"></span><br><span class="line">    struct HashEntry* current = ht-&gt;table[hashValue];</span><br><span class="line">    while (current != NULL) </span><br><span class="line">    &#123;</span><br><span class="line">        if (current-&gt;key == key) </span><br><span class="line">        &#123;</span><br><span class="line">            (current-&gt;value).connected_node = new_connect; </span><br><span class="line">            Serial.println(&quot;Node updated!&quot;); </span><br><span class="line">            break; </span><br><span class="line">        &#125;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Data-structure-process-stack"><a href="#Data-structure-process-stack" class="headerlink" title="Data structure - process stack"></a>Data structure - process stack</h4><p>This is how the rover keeps track of the processes when using the depth-first algorithm. Whenever it meets a dead-end, it goes back and takes the top process on the stack, which would instruct it to check for paths between the last two nodes stored in the process stack. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">struct Process</span><br><span class="line">&#123;</span><br><span class="line">    std::pair&lt;int, int&gt; node_id_pair; </span><br><span class="line">    Process* last_process; </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">Process* stack = new Process; </span><br><span class="line"></span><br><span class="line">void add_process(std::pair&lt;int, int&gt; new_node_id_pair)</span><br><span class="line">&#123;</span><br><span class="line">    Process* new_process = new Process; </span><br><span class="line">    new_process-&gt;node_id_pair = new_node_id_pair; </span><br><span class="line">    new_process-&gt;last_process = stack; </span><br><span class="line">    stack = new_process; </span><br><span class="line">    delete new_process; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void finish_process()</span><br><span class="line">&#123;</span><br><span class="line">    if (stack != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        stack = stack-&gt;last_process; </span><br><span class="line">    &#125;</span><br><span class="line">    else </span><br><span class="line">    &#123;</span><br><span class="line">        currentState = finish; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::pair&lt;int, int&gt; get_process()</span><br><span class="line">&#123;</span><br><span class="line">    return stack-&gt;node_id_pair; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="May-31st-Wed"><a href="#May-31st-Wed" class="headerlink" title="May 31st (Wed)"></a>May 31st (Wed)</h3><p><mark style="background-color: #7099a7;"> Finished the data structure code (mostly). </mark></p>
<p><mark style="background-color: #7099a7;"> We are having an interim presentation tomorrow (20% of this project’s mark, 15 mins of presentation, 5 mins Q&amp;A), so i wrote smth for the PPT (also had a rehearsal with teammates). </mark></p>
<h4 id="Interim-Presentation"><a href="#Interim-Presentation" class="headerlink" title="Interim Presentation"></a>Interim Presentation</h4><p>I’m just putting some screenshots from the PPT. I used animation but they wont show. </p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/data_processing_diagram.jpg?raw=true" alt="data processing diagram"></p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/basic_algorithm.jpg?raw=true" alt="basic algorithm"></p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/data_structure.jpg?raw=true" alt="data structure"></p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/state_machine.jpg?raw=true" alt="state machine"></p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/optimisation_methods.jpg?raw=true" alt="optimisation"></p>
<h4 id="FPGA-algorithm"><a href="#FPGA-algorithm" class="headerlink" title="FPGA algorithm"></a>FPGA algorithm</h4><p>This part shows how we do the image processing on the FPGA side. It is how we technically realised our maze exploring. (Also, it explaines WHY we were using such an approach to do the wall detection. )</p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/wall_detection.jpg?raw=true" alt="wall detection"></p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/wall_detection_algorithm.jpg?raw=true" alt="wall detection algorithm"></p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/beacon_detection_algorithm.jpg?raw=true" alt="beacon detection"></p>
<p>The VGA display used here is just a way to highlight the pixels with different flags so that when debugging with image synchronously showing on the computer, we humans know what the FPGA is “looking at”. </p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/VGA_display.jpg?raw=true" alt="VGA display"></p>
<h4 id="Server-communication"><a href="#Server-communication" class="headerlink" title="Server communication"></a>Server communication</h4><p>A very simple diagram showing how the communication system with server would be like. Also, since the front end plots the maze with rover position only, the json payload would only have 2 keys (x and y coordinates). And once the rover finishes exploring the maze (ie: the process stack is empty), it would enter a state called “finished”, and send the final node graph to the server. (The server would then use dijkstra algorithm to find the best route and plot it on the website. ) I couldnt convince Jessica to write a fixed window size reliable data transport system though. </p>
<p><img src="https://github.com/thisisamor/blog_pic/blob/main/year2/EE-Project/server_communication.jpg?raw=true" alt="server system"></p>
<p><small style="opacity: 0.7;"> life is so difficult, I cried twice today. </small></p>
<hr>
<h3 id="Jun-1st-Thur"><a href="#Jun-1st-Thur" class="headerlink" title="Jun 1st (Thur)"></a>Jun 1st (Thur)</h3><p><mark style="background-color: #7099a7;"> The presentation was ok. </mark></p>
<p><mark style="background-color: #7099a7;"> Finally the motor driver arrived today. It worked fine. NiMH batteries are still not available. Currently we are using the power supply (idk its name, but it’s huge, used for EEE2 experiments i think). </mark></p>
<p><mark style="background-color: #7099a7;"> Wrote code for the optimisation algorithm, I hope we can test the whole procedure with the motors soon. </mark></p>
<p><mark style="background-color: #7099a7;"> Wrote and tested UART communication between ESP32 and FPGA. </mark></p>
<h4 id="Optimisation"><a href="#Optimisation" class="headerlink" title="Optimisation"></a>Optimisation</h4><p>The following code is used in scenarios as mentioned before in the PPT. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;int&gt; delete_connect( std::vector&lt;std::vector&lt;int&gt;&gt; &amp;connect, int delete_id )</span><br><span class="line">&#123;</span><br><span class="line">    std::vector&lt;int&gt; tmp; </span><br><span class="line">    for ( int i=0; i&lt;connect.size(); i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        if ( (connect[i])[0] == delete_id)</span><br><span class="line">        &#123;</span><br><span class="line">            tmp = (connect[i]); </span><br><span class="line">            for ( int j=i; j&lt;connect.size()-1; j++ )</span><br><span class="line">            &#123;</span><br><span class="line">                connect[j] = connect[j+1]; </span><br><span class="line">            &#125;</span><br><span class="line">            connect.pop_back(); </span><br><span class="line">            return tmp; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // should not happen</span><br><span class="line">    return tmp; </span><br><span class="line">    Serial.println(&quot;Wrong: delete connection failed!&quot;); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void insert_new_node( struct HashTable* ht, int node1_id, int node2_id, int new_node_id )</span><br><span class="line">&#123;</span><br><span class="line">    std::vector&lt;int&gt; node1_migrate; </span><br><span class="line">    std::vector&lt;int&gt; node2_migrate; </span><br><span class="line"></span><br><span class="line">    // modify node1 connect</span><br><span class="line">    int hashValue = hashFunction(node1_id); </span><br><span class="line">    struct HashEntry* current = ht-&gt;table[hashValue];</span><br><span class="line">    while (current != NULL) </span><br><span class="line">    &#123;</span><br><span class="line">        if (current-&gt;key == hashValue) </span><br><span class="line">        &#123;</span><br><span class="line">            node1_migrate = delete_connect((current-&gt;value).connected_node, node2_id); </span><br><span class="line">            break; </span><br><span class="line">        &#125;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    // modify node2 connect</span><br><span class="line">    hashValue = hashFunction(node2_id); </span><br><span class="line">    current = ht-&gt;table[hashValue];</span><br><span class="line">    while (current != NULL) </span><br><span class="line">    &#123;</span><br><span class="line">        if (current-&gt;key == hashValue) </span><br><span class="line">        &#123;</span><br><span class="line">            node2_migrate = delete_connect((current-&gt;value).connected_node, node1_id); </span><br><span class="line">            break; </span><br><span class="line">        &#125;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    // add node 1 and node 2 connection into new_node</span><br><span class="line">    hashValue = hashFunction(new_node_id); </span><br><span class="line">    current = ht-&gt;table[hashValue];</span><br><span class="line">    while (current != NULL) </span><br><span class="line">    &#123;</span><br><span class="line">        if (current-&gt;key == hashValue) </span><br><span class="line">        &#123;</span><br><span class="line">            ((current-&gt;value).connected_node).push_back(node1_migrate); </span><br><span class="line">            ((current-&gt;value).connected_node).push_back(node2_migrate); </span><br><span class="line">            break; </span><br><span class="line">        &#125;</span><br><span class="line">        current = current-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Serial.println(&quot;Node inserted between &quot; + String(node1_id) + &quot; and &quot; + String(node2_id) + &quot;!&quot;); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void add_node_at_current_position()</span><br><span class="line">&#123;</span><br><span class="line">    std::vector&lt;std::vector&lt;int&gt;&gt; tmp; </span><br><span class="line">    add_node(current_position, tmp); </span><br><span class="line">    Serial.println(&quot;New node added at current position.&quot;); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void check_node_at_new_node()</span><br><span class="line">&#123;</span><br><span class="line">    struct HashEntry* first = node_graph-&gt;table[0];</span><br><span class="line">    while (first != NULL)    // TODO: (not necessary?) optimise this algorithm </span><br><span class="line">    &#123;</span><br><span class="line">        struct HashEntry* second = node_graph-&gt;table[0];</span><br><span class="line">        while (second != NULL) </span><br><span class="line">        &#123;</span><br><span class="line">            // TODO: double check the parameters! </span><br><span class="line">            if (check_intersection((first-&gt;value).position, (second-&gt;value).position, (get_node(node_graph, last_id)).position, (get_node(node_graph, last_id-1)).position))</span><br><span class="line">            &#123;</span><br><span class="line">                std::pair&lt;int, int&gt; new_node_position = intersection_calculation((first-&gt;value).position, (second-&gt;value).position, (get_node(node_graph, last_id)).position, (get_node(node_graph, last_id-1)).position); </span><br><span class="line">                std::vector&lt;std::vector&lt;int&gt;&gt; tmp; </span><br><span class="line">                add_node(new_node_position, tmp); </span><br><span class="line">                insert_new_node(node_graph, (first-&gt;value).node_id, (second-&gt;value).node_id, last_id); </span><br><span class="line">                Serial.println(&quot;New node added at (&quot; + String(new_node_position.first) + &quot;, &quot; + String(new_node_position.second) + &quot; ).&quot;); </span><br><span class="line">            &#125;</span><br><span class="line">            second = second-&gt;next; </span><br><span class="line">        &#125;</span><br><span class="line">        first = first-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="UART-communication"><a href="#UART-communication" class="headerlink" title="UART communication"></a>UART communication</h4><p>This would enable ESP32 to read 32 bits messages from FPGA (rather than digital read from pin which is only 1 bit). The 7 pins currently reserved for FPGA could be reduced to only 2 pins. </p>
<p>Set up two serials (one for monitor output, one for UART communication): </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pinMode(UART_RXD, INPUT); </span><br><span class="line">pinMode(UART_TXD, OUTPUT); </span><br><span class="line">Serial.begin(115200);</span><br><span class="line">Serial2.begin(115200, SERIAL_8N1, UART_RXD, UART_TXD); </span><br></pre></td></tr></table></figure>

<p>Read and print in serial monitor: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String UART_read_FPGA()</span><br><span class="line">&#123;</span><br><span class="line">    if (Serial2.available() &gt; 0) </span><br><span class="line">    &#123;</span><br><span class="line">        // read the incoming bytes:</span><br><span class="line">        Serial.println(Serial2.read());</span><br><span class="line">        return String(Serial2.read()); </span><br><span class="line">    &#125;</span><br><span class="line">    else </span><br><span class="line">    &#123;</span><br><span class="line">        Serial.println(&quot;UART not available.&quot;);</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>With the help of UART, more complexed image processing might be possible. </p>
<p><small style="opacity: 0.7;"> idk, it’s still so difficult. </small></p>
<p><small style="opacity: 0.7;"> i heard that one group was using UART to send the full image to ESP32, who post it to the server. the server then process it using open cv, and send command back to the rover. but the time delay was quite long. </small></p>
<hr>
<h3 id="Jun-2nd-Fri"><a href="#Jun-2nd-Fri" class="headerlink" title="Jun 2nd (Fri)"></a>Jun 2nd (Fri)</h3><p><mark style="background-color: #7099a7;"> Tested stepper motor control code. </mark></p>
<p><mark style="background-color: #7099a7;"> Discussed what data would be sent bia UART for most efficient image processing. (we might build a very simple instruction set for that purpose) However the actual scenarios would be so complicated, i dont see that realised very soon. </mark></p>
<p><mark style="background-color: #7099a7;"> Redesigned chasis for a vertically balanced rover (a higher centre of mass would shorten the distance to be moved by the rover to dynamically balance) and planned the part where provides ajustable angle and height of the camera implementation. </mark></p>
<p><mark style="background-color: #7099a7;"> Discussed Nicholas’s work on MCU6050 gyroscope and accelerometer, planned on design of controller for balnacing. </mark></p>
<h4 id="Stepper-motor-control-1"><a href="#Stepper-motor-control-1" class="headerlink" title="Stepper motor control"></a>Stepper motor control</h4><p>A step of 2 seconds high and 2 seconds low would result in 1.8 degree of motor move. The current design would allow 200 steps per motor revolution. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void motor_control(int STPL, int STPR, int DIRL, int DIRR, int n) </span><br><span class="line">&#123;</span><br><span class="line">  digitalWrite(DIRL, LOW);</span><br><span class="line">  digitalWrite(DIRR, HIGH);</span><br><span class="line"></span><br><span class="line">  for(int i=0; i&lt;200*n; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    digitalWrite(STPL, HIGH);</span><br><span class="line">    digitalWrite(STPR, HIGH);</span><br><span class="line">    delayMicroseconds(2000);</span><br><span class="line">    digitalWrite(STPL, LOW);</span><br><span class="line">    digitalWrite(STPR, LOW);</span><br><span class="line">    delayMicroseconds(2000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="MCU6050-data-processing"><a href="#MCU6050-data-processing" class="headerlink" title="MCU6050 data processing"></a>MCU6050 data processing</h4><p>The MCU6050 module has built-in gyroscope and accelerometer, which would give reading in three different axis (x, y, z, left-hand rules tho). </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">MPU_6050::MPU_6050(float aCompFilterParam, Cartesian aAccAngles, Cartesian aGryoAngles, Cartesian aFilteredAngles, Cartesian aGyroCalValues, Cartesian aGyroAngleVelCal)&#123;</span><br><span class="line">  mpu = Adafruit_MPU6050();</span><br><span class="line">  accAngles = aAccAngles;</span><br><span class="line">  gyroAngles = aGryoAngles;</span><br><span class="line">  filteredAngles = aFilteredAngles;</span><br><span class="line">  gyroCalValues = aGyroCalValues;</span><br><span class="line">  gyroAngVelCal = aGyroAngleVelCal;</span><br><span class="line">  compFilterParam = aCompFilterParam;</span><br><span class="line">  previousTime = 0.0;</span><br><span class="line">  currentTime = 0.0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MPU_6050::MPU_6050(const MPU_6050&amp; anMPU)&#123;</span><br><span class="line">  *this = anMPU;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MPU_6050::~MPU_6050()&#123;&#125;</span><br><span class="line"></span><br><span class="line">MPU_6050&amp; MPU_6050::operator=(const MPU_6050&amp; anMPU)&#123;</span><br><span class="line">  mpu = Adafruit_MPU6050(anMPU.mpu);    // Calling the Adafruit_MPU6050 copy constructor.</span><br><span class="line">  a = anMPU.a;</span><br><span class="line">  g = anMPU.g;</span><br><span class="line">  temp = anMPU.temp;</span><br><span class="line">  accAngles = anMPU.accAngles;</span><br><span class="line">  gyroAngles = anMPU.gyroAngles;</span><br><span class="line">  filteredAngles = anMPU.filteredAngles;</span><br><span class="line">  gyroCalValues = anMPU.gyroCalValues;</span><br><span class="line">  gyroAngVelCal = anMPU.gyroAngVelCal;</span><br><span class="line">  compFilterParam = anMPU.compFilterParam;</span><br><span class="line">  previousTime = anMPU.previousTime;</span><br><span class="line">  currentTime = anMPU.currentTime;</span><br><span class="line">  return *this;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// Activates and configures the MPU 6050. Returns &quot;false&quot; if failed, otherwise &quot;true&quot;.</span><br><span class="line">// NOTE: Remember that inside member methods of a class, &quot;this-&gt;&quot; is implied when referencing other class members.</span><br><span class="line">bool MPU_6050::activate() &#123;</span><br><span class="line">  // Activating the MPU 6050. </span><br><span class="line">  if (!mpu.begin()) &#123;</span><br><span class="line">    Serial.println(&quot;Failed to find MPU6050 chip.&quot;);</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(&quot;MPU6050 Found.&quot;);</span><br><span class="line"></span><br><span class="line">  // Configuring the accelerometer.</span><br><span class="line">  mpu.setAccelerometerRange(MPU6050_RANGE_4_G);</span><br><span class="line"></span><br><span class="line">  // Configuring the gyro.</span><br><span class="line">  mpu.setGyroRange(MPU6050_RANGE_500_DEG);</span><br><span class="line">  mpu.setFilterBandwidth(MPU6050_BAND_44_HZ);</span><br><span class="line"></span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Calibrates the Gyroscope. Should be run when the MPU 6050 is in a stationary position.  Returns &quot;false&quot; if failed, otherwise &quot;true&quot;.</span><br><span class="line">bool MPU_6050::gyro_calibrate()&#123;</span><br><span class="line">  Serial.println(&quot;Calibrating gyro, place on level surface and do not move.&quot;);</span><br><span class="line">  gyroCalValues = Cartesian&#123;0, 0, 0&#125;;   // Reset the gyro calibration values to 0.</span><br><span class="line"></span><br><span class="line">  // Take 3000 readings for each coordinate.</span><br><span class="line">  for (int cal_int = 0; cal_int &lt; 3000; cal_int ++)&#123;</span><br><span class="line">    if(cal_int % 200 == 0) Serial.print(&quot;.&quot;);</span><br><span class="line">    mpu.getEvent(&amp;a, &amp;g, &amp;temp);     // Get new sensor event values without updating data members.</span><br><span class="line">    gyroCalValues.x += g.gyro.x;</span><br><span class="line">    gyroCalValues.y += g.gyro.y;</span><br><span class="line">    gyroCalValues.z += g.gyro.z;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Average the values</span><br><span class="line">  gyroCalValues.x /= 3000;</span><br><span class="line">  gyroCalValues.y /= 3000;</span><br><span class="line">  gyroCalValues.z /= 3000;</span><br><span class="line"></span><br><span class="line">  // The MPU should start running right after calibration, meaning that we now set our initial &quot;currentTime&quot;.</span><br><span class="line">  currentTime = micros();</span><br><span class="line"></span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Measures sensor event values and updates relevant data members. Returns &quot;false&quot; if failed, otherwise &quot;true&quot;.</span><br><span class="line">bool MPU_6050::readSensor()&#123;</span><br><span class="line">  mpu.getEvent(&amp;a, &amp;g, &amp;temp);     // Get new sensor event values.</span><br><span class="line">  updateData();</span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Updates relevant data members in the class with new values read from the sensor. Returns &quot;false&quot; if failed, otherwise &quot;true&quot;.</span><br><span class="line">bool MPU_6050::updateData()&#123;</span><br><span class="line">  // Updating time variables.</span><br><span class="line">  previousTime = currentTime;</span><br><span class="line">  currentTime = micros();    // micros() returns the time in microseconds since the current program started running.</span><br><span class="line"></span><br><span class="line">  // Updating calibrated angular velocity values.</span><br><span class="line">  gyroAngVelCal = calcAngVelCal();</span><br><span class="line"></span><br><span class="line">  // Updating the accelerometer calculated angle values.</span><br><span class="line">  accAngles = calcAccAngles();</span><br><span class="line"></span><br><span class="line">  // Updating the gyroscope calculated angle values.</span><br><span class="line">  gyroAngles = calcGyroAngles();</span><br><span class="line"></span><br><span class="line">  // Updating the Complementary Filter calculated angle values.</span><br><span class="line">  filteredAngles = calcFilteredAngles();</span><br><span class="line"></span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Calculates the Calibrated Gyroscope Angular Velocity values.</span><br><span class="line">Cartesian MPU_6050::calcAngVelCal()&#123;</span><br><span class="line">  Cartesian adjustedGyro;</span><br><span class="line">  // Define new gyroscope angular velocities in degrees/s with the calibration offset values subtracted.</span><br><span class="line">  adjustedGyro.x = (g.gyro.x - gyroCalValues.x)*RAD_TO_DEG;</span><br><span class="line">  adjustedGyro.y = (g.gyro.y - gyroCalValues.y)*RAD_TO_DEG;</span><br><span class="line">  adjustedGyro.z = (g.gyro.z - gyroCalValues.z)*RAD_TO_DEG;</span><br><span class="line"></span><br><span class="line">  return adjustedGyro;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Calculates the orientation of the MPU 6050 using only accelerometer data.</span><br><span class="line">Cartesian MPU_6050::calcAccAngles()&#123;</span><br><span class="line">  Cartesian angles;</span><br><span class="line">  angles.x = getAccRoll(a);    // Roll is the rotation about the x-axis.</span><br><span class="line">  angles.y = getAccPitch(a);   // Pitch is the rotation about the y-axis.</span><br><span class="line">  angles.z = getAccYaw(a);     // Yaw is the rotation about the z-axis.</span><br><span class="line">  return angles;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Calculates the orientation of the MPU 6050 using only gyroscope data.</span><br><span class="line">Cartesian MPU_6050::calcGyroAngles()&#123;</span><br><span class="line">  Cartesian angles = gyroAngles;    // Initialize with the current gyro estimated angles.</span><br><span class="line">  float dt;</span><br><span class="line">  Cartesian adjustedGyroVel = calcAngVelCal();</span><br><span class="line"></span><br><span class="line">  // Calculating the change in time elapsed since the last measurement in seconds. This change in time is used for the integration approximation.</span><br><span class="line">  dt = (currentTime - previousTime)/1000000.0;</span><br><span class="line"></span><br><span class="line">  // Gyroscope estimated angle values. These are integrals over time and will tend to drift.</span><br><span class="line">  angles.x += adjustedGyroVel.x*dt;     </span><br><span class="line">  angles.y += adjustedGyroVel.y*dt;</span><br><span class="line">  angles.z += adjustedGyroVel.z*dt;</span><br><span class="line"></span><br><span class="line">  // Changing angles to be within -180 and 180 degrees.</span><br><span class="line">  angles.x = normalizeAngle(angles.x);</span><br><span class="line">  angles.y = normalizeAngle(angles.y);</span><br><span class="line">  angles.z = normalizeAngle(angles.z);</span><br><span class="line"></span><br><span class="line">  return angles;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Calculates the orientation of the MPU 6050 using accelerometer and gyroscope data with a Complementary Filter.</span><br><span class="line">Cartesian MPU_6050::calcFilteredAngles()&#123;</span><br><span class="line">  Cartesian angles;</span><br><span class="line">  float dt;</span><br><span class="line">  Cartesian adjustedGyroVel = calcAngVelCal();</span><br><span class="line">  Cartesian accelAngles = calcAccAngles();</span><br><span class="line"></span><br><span class="line">  // Calculating the change in time elapsed since the last measurement in seconds. This change in time is used for the integration approximation.</span><br><span class="line">  dt = (currentTime - previousTime)/1000000.0;</span><br><span class="line"></span><br><span class="line">  // Complementary filter. (NOTE: A complementary filter is a computationally inexpensive sensor fusion technique that consists of a low-pass and a high-pass filter).</span><br><span class="line">  // In this case the low-pass and high-pass filter are modeled as scalar multiplications to different terms.</span><br><span class="line">  // This way we can combine the gyro and accelerometer measurements to get more accurate pitch, roll, and yaw values.</span><br><span class="line">  angles.x = (compFilterParam)*(filteredAngles.x + adjustedGyroVel.x*dt) + (1-compFilterParam)*(accelAngles.x);   // The first term in this equation represents the previous filtered angle plus the integral of angular velocity from the gyro. The second term is the estimated accelerometer angle.</span><br><span class="line">  angles.y = (compFilterParam)*(filteredAngles.y + adjustedGyroVel.y*dt) + (1-compFilterParam)*(accelAngles.y);</span><br><span class="line">  angles.z = (compFilterParam)*(filteredAngles.z + adjustedGyroVel.z*dt) + (1-compFilterParam)*(accelAngles.z);</span><br><span class="line"></span><br><span class="line">  return angles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For usage in main function, the following class is used so every time <code>mpu6050.readSensor();</code> is called, it updates all readings for controller to use. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class MPU_6050&#123;</span><br><span class="line">public:</span><br><span class="line">    // Default constructor (Remember that you do not need a default argument for every data member in a class. Additionally, when using the default constructor, variables with default arguments can be omitted as parameters and their default value will be assumed.)</span><br><span class="line">    // It is also important to note that if you want to initialize the object with different values for certain default arguments, you need to enter a value for each default argument preceding the one you want to specify in the constructor input parameters. Hence, put the variables you are most likely to specify at the beginning of you input parameters.</span><br><span class="line">    MPU_6050(float aCompFilterParam = 0.98, Cartesian aAccAngles=Cartesian&#123;0, 0, 0&#125;, Cartesian aGryoAngles=Cartesian&#123;0, 0, 0&#125;,</span><br><span class="line">            Cartesian aFilteredAngles=Cartesian&#123;0, 0, 0&#125;,  Cartesian aGyroCalValues=Cartesian&#123;0, 0, 0&#125;,</span><br><span class="line">            Cartesian aGyroAngleVelCal=Cartesian&#123;0, 0, 0&#125;);</span><br><span class="line">    MPU_6050(const MPU_6050&amp; anMPU);        // Copy constructor</span><br><span class="line">    ~MPU_6050();        // Destructor</span><br><span class="line"></span><br><span class="line">    MPU_6050&amp; operator=(const MPU_6050&amp; anMPU);     // Assignment operator</span><br><span class="line"></span><br><span class="line">    // Methods</span><br><span class="line">    bool activate();</span><br><span class="line">    bool gyro_calibrate();</span><br><span class="line">    bool readSensor();</span><br><span class="line">    bool updateData();</span><br><span class="line">    Cartesian calcAngVelCal();</span><br><span class="line">    Cartesian calcAccAngles();</span><br><span class="line">    Cartesian calcGyroAngles();</span><br><span class="line">    Cartesian calcFilteredAngles();</span><br><span class="line"></span><br><span class="line">    // Data Members</span><br><span class="line">    Adafruit_MPU6050 mpu;       // Adafruit MPU 6050 object.</span><br><span class="line">    sensors_event_t a, g, temp;     // Accelerometer, gyroscope, and temperature sensor last measured sensor event values.</span><br><span class="line">    Cartesian accAngles;       // Accelerometer calculated angle values.</span><br><span class="line">    Cartesian gyroAngles;      // Gyroscope calculated angle values.</span><br><span class="line">    Cartesian filteredAngles;  // Calculated angle values after the Complementary Filter.</span><br><span class="line">    Cartesian gyroCalValues;   // Stores the x, y, and z gyro calibration values.</span><br><span class="line">    Cartesian gyroAngVelCal;   // Stores the calibrated angular velocity values in degrees/s.</span><br><span class="line">    float compFilterParam;          // Parameter that defines the LPF and HPF for the angle calculation Complementary Filter.</span><br><span class="line">    unsigned long previousTime;     // Stores the previous time when a sensor event was read. Used for integration calculations.</span><br><span class="line">    unsigned long currentTime;      // Stores the current time when a sensor event was read. Used for itegration calculations.</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Chasis-and-balance"><a href="#Chasis-and-balance" class="headerlink" title="Chasis and balance"></a>Chasis and balance</h4><p>The major concern is that, the camera requires a rather critical angle between itself and ground to read pixels from the correct threshold region (and also the height from the ground matters for the beacons). </p>
<p>However, the balancing system could only dynamically try to stay in that balnaced state (by constantly, slightly, moving forward and backward) and not collide, obviously. </p>
<p>These two kinda conflict and we would have to find a trade-off in between. We may even have to add some command to judge whether or not the current position is “a state where the camera detection result is usable”. </p>
<hr>
<p>This weekend: </p>
<ul>
<li><p><input checked="" disabled="" type="checkbox"> 
Read doc on controller modelling</p>
</li>
<li><p><input disabled="" type="checkbox"> 
try? designing a simple controller model, settling time very important!!!</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
How to put the controller and motor function together? </p>
</li>
<li><p><input disabled="" type="checkbox"> 
(optional) is there a way to model all scenarios that might be captured by camera at sometime throughout demo? </p>
<ul>
<li><input disabled="" type="checkbox"> calculate angle from camera image? </li>
<li><input disabled="" type="checkbox"> detection of path from camera image?</li>
</ul>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/college/" rel="tag"># college</a>
              <a href="/tags/project/" rel="tag"># project</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/05/16/007-Discrete-Maths-Review/" rel="prev" title="Discrete Maths Review">
                  <i class="fa fa-chevron-left"></i> Discrete Maths Review
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/06/18/009-EE-Project-Work-Diary-pt2/" rel="next" title="EE Project Work Diary (pt2)">
                  EE Project Work Diary (pt2) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa-solid fa-carrot"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Amor</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.4.3/mermaid.min.js","integrity":"sha256-e0o3JYsdjqKajf9eOe22FhioYSz9WofRY4dLKo3F6do="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
